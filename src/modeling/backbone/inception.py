from torch import nn
from torchvision import models
from torchvision.models.inception import Inception_V3_Weights

from src.utils.registry import REGISTRY

@REGISTRY.register('inception')
class InceptionModel(nn.Module):
    def __init__(self, num_classes=5):
        super(InceptionModel, self).__init__()
        self.inception = models.inception_v3(weights=Inception_V3_Weights.DEFAULT)
        self.inception.AuxLogits.fc = nn.Linear(768, num_classes)
        self.inception.fc = nn.Linear(2048, num_classes)
    
    def forward(self, inputs):
        return self.inception(inputs)
    
    def get_layer_groups(self):
        linear_layers = [elem[1] for elem in filter(lambda param_tuple: 'fc' in param_tuple[0], self.inception.named_parameters())]
        other_layers = [elem[1] for elem in filter(lambda param_tuple: 'fc' not in param_tuple[0], self.inception.named_parameters())]
        param_groups = {
            'classifier': linear_layers,
            'feature_extractor': other_layers 
        }
        return param_groups